name: Daily Stock Prices - VinFast & VinGroup

on:
  schedule:
    # Runs at 9:00 PM UTC (4:00 PM EST, 1:00 PM PST) on weekdays
    # After US market close (4:00 PM EST)
    - cron: '0 21 * * 1-5'
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  post-stock-prices:
    name: Fetch and Post Stock Prices
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests yfinance pandas-market-calendars

      - name: Fetch stock prices and post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_STOCK_WEBHOOK_URL }}
        run: |
          python3 << 'EOF'
          import requests
          import yfinance as yf
          import os
          from datetime import datetime, timedelta
          import sys
          import pandas_market_calendars as mcal

          # Get Discord webhook URL from environment
          webhook_url = os.environ.get('DISCORD_WEBHOOK_URL')

          if not webhook_url:
              print("ERROR: DISCORD_WEBHOOK_URL secret not set")
              sys.exit(1)

          # Check if US market is open today
          try:
              nasdaq = mcal.get_calendar('NASDAQ')
              today = datetime.now().date()
              schedule = nasdaq.schedule(start_date=today, end_date=today)

              if schedule.empty:
                  print(f"â¸ï¸  US market closed today ({today.strftime('%B %d, %Y')})")
                  print("Skipping post - no fresh data available")
                  sys.exit(0)  # Exit gracefully, not an error
              else:
                  print(f"âœ… US market open today ({today.strftime('%B %d, %Y')})")
          except Exception as e:
              print(f"âš ï¸  Could not check market status: {e}")
              print("Proceeding with data fetch anyway...")

          # Stock tickers
          # VFS: VinFast Auto Ltd (NASDAQ)
          # VIC.VN: Vingroup JSC (Vietnam Stock Exchange)
          tickers = {
              "VinFast Auto (VFS)": "VFS",
              "VinGroup (VIC)": "VIC.VN"
          }

          # Get current date
          today_str = datetime.now().strftime("%B %d, %Y")

          # Fetch stock data
          stock_data = {}
          errors = []
          data_is_fresh = False

          for name, ticker in tickers.items():
              try:
                  stock = yf.Ticker(ticker)
                  hist = stock.history(period="5d")  # Get last 5 days for comparison

                  if len(hist) > 0:
                      # Get the most recent data
                      latest_date = hist.index[-1].date()
                      current_price = hist['Close'].iloc[-1]

                      # Check if data is from today or yesterday (for Vietnam timezone)
                      today = datetime.now().date()
                      yesterday = today - timedelta(days=1)

                      # Consider data fresh if it's from today or yesterday
                      # (Vietnam is ahead in timezone, might show yesterday's date)
                      is_recent = latest_date >= yesterday

                      if is_recent:
                          data_is_fresh = True

                      # Calculate change if we have previous day data
                      if len(hist) > 1:
                          prev_price = hist['Close'].iloc[-2]
                          change = current_price - prev_price
                          change_pct = (change / prev_price) * 100
                      else:
                          change = 0
                          change_pct = 0

                      stock_data[name] = {
                          'ticker': ticker,
                          'price': current_price,
                          'change': change,
                          'change_pct': change_pct,
                          'currency': 'USD' if ticker == 'VFS' else 'VND',
                          'date': latest_date,
                          'is_recent': is_recent
                      }

                      print(f"âœ… {name}: ${current_price:.2f} (data from {latest_date})")
                  else:
                      errors.append(f"{name} ({ticker}): No data available")
                      print(f"âŒ {name}: No data available")
              except Exception as e:
                  errors.append(f"{name} ({ticker}): {str(e)}")
                  print(f"âŒ {name}: Error - {str(e)}")

          # Only post if we have fresh data
          if not data_is_fresh and stock_data:
              print(f"â¸ï¸  All data is stale (not from today). Skipping post.")
              print("This is normal on market holidays.")
              sys.exit(0)  # Exit gracefully

          # Build Discord embed message
          embeds = []

          # Main embed
          if stock_data:
              # Check if any data is stale
              stale_data = any(not data['is_recent'] for data in stock_data.values())

              if stale_data:
                  description = f"ðŸ“ˆ **Latest Available Prices - {today_str}**\n"
                  description += f"âš ï¸ *Market may be closed - showing last trading day*\n\n"
              else:
                  description = f"ðŸ“ˆ **Daily Closing Prices - {today_str}**\n\n"

              for name, data in stock_data.items():
                  price = data['price']
                  change = data['change']
                  change_pct = data['change_pct']
                  currency = data['currency']
                  ticker = data['ticker']
                  data_date = data['date']

                  # Format price based on currency
                  if currency == 'USD':
                      price_str = f"${price:.2f}"
                      change_str = f"${abs(change):.2f}"
                  else:
                      price_str = f"{price:,.0f} â‚«"
                      change_str = f"{abs(change):,.0f} â‚«"

                  # Determine emoji and color based on change
                  if change > 0:
                      emoji = "ðŸŸ¢"
                      sign = "+"
                      color = 0x00FF00  # Green
                  elif change < 0:
                      emoji = "ðŸ”´"
                      sign = "-"
                      color = 0xFF0000  # Red
                  else:
                      emoji = "âšª"
                      sign = ""
                      color = 0x808080  # Gray

                  description += f"{emoji} **{name}** (`{ticker}`)\n"
                  description += f"   Price: **{price_str}**\n"
                  description += f"   Change: {sign}{change_str} ({sign}{abs(change_pct):.2f}%)\n"

                  # Show data date if not today
                  today = datetime.now().date()
                  if data_date != today:
                      description += f"   ðŸ“… Data from: {data_date.strftime('%b %d, %Y')}\n"

                  description += "\n"

              embed = {
                  "title": "ðŸ“Š VinFast & VinGroup Stock Update",
                  "description": description,
                  "color": 0x00539C,  # VinFast blue
                  "footer": {
                      "text": "Data from Yahoo Finance | Automated by VinFastOwners.org"
                  },
                  "timestamp": datetime.utcnow().isoformat()
              }
              embeds.append(embed)

          # Add error embed if there are errors
          if errors:
              error_description = "âš ï¸ **Errors fetching data:**\n\n"
              for error in errors:
                  error_description += f"â€¢ {error}\n"

              error_embed = {
                  "title": "Stock Data Errors",
                  "description": error_description,
                  "color": 0xFFA500  # Orange
              }
              embeds.append(error_embed)

          # Post to Discord
          if embeds:
              payload = {
                  "username": "Stock Bot",
                  "avatar_url": "https://raw.githubusercontent.com/vinfastownersorg-cyber/avo-website/main/images/icons/avo-logo.png",
                  "embeds": embeds
              }

              response = requests.post(webhook_url, json=payload)

              if response.status_code == 204:
                  print("âœ… Successfully posted stock prices to Discord")
              else:
                  print(f"âŒ Failed to post to Discord: {response.status_code}")
                  print(response.text)
                  sys.exit(1)
          else:
              print("âŒ No stock data to post")
              sys.exit(1)

          EOF

      - name: Log completion
        if: always()
        run: |
          echo "Stock price workflow completed at $(date)"
